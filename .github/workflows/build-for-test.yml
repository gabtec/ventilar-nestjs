name: Build For E2E Testing CI

on: workflow_dispatch

env:
  REG_URL: reg.gabtec.pt/xgeeks/
  PROJ_NAME: gh-ventilar-api
  PROJ_VERSION: v0.0.6

jobs:
  testing:
    runs-on: ubuntu-latest
    # container:
    #   image: postgres:15.1-alpine
    #   ports:
    #     - '5432:5432'
    #   environment:
    #     - POSTGRES_PASSWORD=admin
    #     - POSTGRES_USER=admin
    #     - POSTGRES_DB=ventilar_db_test
    services:
      image: postgres:15.1-alpine
      ports:
        - '5432:5432'
      environment:
        - POSTGRES_PASSWORD=admin
        - POSTGRES_USER=admin
        - POSTGRES_DB=ventilar_db_test
    steps:
      - uses: actions/checkout@v3
      - name: create env file for testing
        run: |
          touch .env
          echo API_SRV_PORT=3002 >> .env
          echo DB_DRIVER=postgres >> .env
          echo DB_HOST=localhost >> .env
          echo DB_PORT=5432 >> .env
          echo DB_USER=admin >> .env
          echo DB_PASSWORD=admin >> .env
          echo DB_NAME=ventilar_db_test >> .env
          echo ACCESS_TOKEN_SECRET=foo >> .env
          echo ACCESS_TOKEN_DURATION=60 >> .env
          echo REFRESH_TOKEN_SECRET=bar >> .env
          echo REFRESH_TOKEN_DURATION=86400 >> .env

      - name: Run build
        run: npm run build
      - name: Generate db migrations
        run: npm run migration:generate:all
      - name: Run db migrations
        run: npm run migration:run
      - name: Run db seeds
        uses: npm run test:db:seed
      - name: Run tests
        run: npm run test
